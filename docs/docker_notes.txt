Docker Install Ubuntu on Linode
=====================
adduser calypso
XXX===> passwd calypso <== nope
sudo vi /etc/sudoers ==> calypso ALL=(ALL) NOPASSWD:ALL <== near end
vi /etc/passwd ===> calypso:x:1000:1000::/home/calypso:/bin/bash <== make bash
 
 ????user /etc/skel?????

vi /etc/ssh/sshd_config
Port 63913
PermitRootLogin no

https://www.linode.com/docs/guides/use-public-key-authentication-with-ssh/

mkdir -p ~/.ssh && touch ~/.ssh/authorized_keys
chmod 700 ~/.ssh && chmod 600 ~/.ssh/authorized_keys
vi ~/.ssh/authorized_key
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys
chown $USER:$USER ~/.ssh -R

PasswordAuthentication no

sudo systemctl restart sshd

sudo apt install net-tools

https://www.linode.com/docs/guides/using-fail2ban-to-secure-your-server-a-tutorial/

sudo apt-get update
sudo apt-get install \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg \
    lsb-release
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io
sudo docker run hello-world

sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
docker-compose --version

https://blog.ssdnodes.com/blog/host-multiple-ssl-websites-docker-nginx/
https://www.youtube.com/watch?v=Iaf6VocUrTQ&t=692s

cd /home/calypso
mkdir docker
cd docker

mkdir nginx-proxy && cd nginx-proxy
mkdir log
touch log/access.log
touch log/error.log

sudo docker network create nginx-proxy
copy over files docker-compose.yml  nginx.tmpl
sudo docker-compose up -d

sudo apt-get update && apt-get upgrade -y
sudo apt-get install fail2ban
sudo ufw allow 63913
sudo ufw enable
sudo cp /etc/fail2ban/fail2ban.conf /etc/fail2ban/fail2ban.local
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local

enabled = true
/home/calypso/docker/nginx-proxy/log/error.log
/home/calypso/docker/nginx-proxy/log/access.log

Build Docker Image
=======================================================================
 1. cd ~/dotnet
 2. git clone git@github.com:CalypsoSys/matrixease.git pwd
 3. cd ~/dotnet/MatrixEase/
 4. git pull or git checkout "branch I want"
 5. cd web_blaster
 6. dotnet build --configuration Release
 7. cd ..
 8. ~/dotnet/MatrixEase/bin/web_blaster Ubuntu Release ~/dotnet/MatrixEase/static.MatrixEase.Manga ~/dotnet/MatrixEase/matrixease.web/wwwroot googs
 9. sudo docker build -t matrixease_web .
10. sudo docker rmi -f $(sudo docker images -f "dangling=true" -q)
11. sudo docker save matrixease_web > /home/calypsosys/Docker/matrixease_web.tar
12. copy matrixease_web.tar copy to c:\transfer and C:\CalypsoSystems\MatrixEase\matrixease.com\download


Init Docker Image
==================
 1. copy matrixease_web.tar to /home/calypso/docker (on deployment machine)
 2. cd ~/
 3. mkdir docker
 4. cd docker
 5. sudo docker load <  matrixease_web.tar
 6. sudo docker rmi -f $(sudo docker images -f "dangling=true" -q)
 7. mkdir matrixease_dotnet
 8. cd matrixease_dotnet
 9. copy over Docker/docker-compose.yml
10. mkdir app
11. copy over appsettings_prod_docker.json to app as appsettings.json
12. mkdir mangadata


Notes
=====
sudo docker logs -f nginx-proxy
sudo docker logs -f matrixease_web
sudo docker exec -it matrixease_web /bin/bash

swapon -s
sudo fallocate -l 512M /swapfile(2)
sudo chmod 600 /swapfile(2)
sudo mkswap /swapfile(2)
sudo swapon /swapfile(2)
swapon -s
vi /etc/fstab
sudo vi /etc/fstab
swapon -s
free -m 

sudo sh -c "echo 'truncate -s 0 /var/lib/docker/containers/*/*-json.log' > /etc/cron.daily/clear_docker_logs"
 docker exec -it  nginx-proxy-le /bin/bash




